总操作流程：
- 1、[下载](#docker-01)
- 2、[配置](#docker-02)
- 3、[测试](#docker-03)

***

# <a name="docker-01" href="#" >下载</a>

> 下拉redis

```shell
docker pull redis:latest
```

> 安装docker-compose 

```
curl -L https://github.com/docker/compose/releases/download/1.23.2/run.sh > /usr/local/bin/docker-compose

chmod +x /usr/local/bin/docker-compose

docker-compose version
```

# <a name="docker-02" href="#" >配置</a>

> 创建redis配置文件

```shell
mkdir -p /usr/local/redis/redis-cluster
cd /usr/local/redis/redis-cluster
touch redis-cluster.tmpl
chmod 0777 redis-cluster.tmpl
vim redis-cluster.tmpl
```

```shell
port ${PORT}
protected-mode no
cluster-enabled yes
pidfile  /var/run/redis_${PORT}.pid 
cluster-config-file nodes_${PORT}.conf
cluster-node-timeout 15000
cluster-announce-port ${PORT}
cluster-announce-bus-port 1${PORT}
appendonly yes
```

> 创建文件夹和文件

```shell

# 生成conf、data文件夹和配置信息
for port in `seq 6666 6671`; do \
  mkdir -p ./${port}/conf \
  && PORT=${port} envsubst < ./redis-cluster.tmpl > ./${port}/conf/redis.conf \
  && mkdir -p ./${port}/data \
  && chmod 777 ./${port}/conf/redis.conf; \
done
```
> 创建docker-compose.yml

```shell
mkdir -p /usr/local/docker-compose
cd /usr/local/docker-compose
touch docker-compose.yml
chmod 777 docker-compose.yml
vim docker-compose.yml
```

<details>
<summary>配置</summary>

```yml
version: "3"
services:
  redis-6666:
    image: redis:latest
    container_name: redis-6666
    command: redis-server /etc/redis/redis.conf
    restart: always
    ports: 
      - "6666:6666"
      - "16666:16666"
    environment:
      - PORT=6666
    stdin_open: true
    tty: true
    privileged: true
    volumes:                                                  
      - /usr/local/redis/redis-cluster/6666/conf/redis.conf:/etc/redis/redis.conf:rw
      - /usr/local/redis/redis-cluster/6666/data:/data:rw
    networks:
      redis-master:
        ipv4_address: 172.50.0.2
    
  redis-6667:
    image: redis:latest
    container_name: redis-6667
    command: redis-server /etc/redis/redis.conf
    restart: always
    ports: 
      - "6667:6667"
      - "16667:16667"
    environment:
      - PORT=6667
    stdin_open: true
    tty: true
    privileged: true
    volumes:                                                  
      - /usr/local/redis/redis-cluster/6667/conf/redis.conf:/etc/redis/redis.conf:rw
      - /usr/local/redis/redis-cluster/6667/data:/data:rw
    networks:
      redis-master:
        ipv4_address: 172.50.0.3
    
  redis-6668:
    image: redis:latest
    container_name: redis-6668
    command: redis-server /etc/redis/redis.conf
    restart: always
    ports: 
      - "6668:6668"
      - "16668:16668"
    environment:
      - PORT=6668
    stdin_open: true
    tty: true
    privileged: true
    volumes:                                                  
      - /usr/local/redis/redis-cluster/6668/conf/redis.conf:/etc/redis/redis.conf:rw
      - /usr/local/redis/redis-cluster/6668/data:/data:rw
    networks:
      redis-master:
        ipv4_address: 172.50.0.4
    
  redis-6669:
    image: redis:latest
    container_name: redis-6669
    command: redis-server /etc/redis/redis.conf
    restart: always
    ports: 
      - "6669:6669"
      - "16669:16669"
    environment:
      - PORT=6669
    stdin_open: true
    tty: true
    privileged: true
    volumes:                                                  
      - /usr/local/redis/redis-cluster/6669/conf/redis.conf:/etc/redis/redis.conf:rw
      - /usr/local/redis/redis-cluster/6669/data:/data:rw
    networks:
      redis-slave:
        ipv4_address: 172.30.0.2
    
  redis-6670:
    image: redis:latest
    container_name: redis-6670
    command: redis-server /etc/redis/redis.conf
    restart: always
    ports: 
      - "6670:6670"
      - "16670:16670"
    environment:
      - PORT=6670
    stdin_open: true
    tty: true
    privileged: true
    volumes:                                                  
      - /usr/local/redis/redis-cluster/6670/conf/redis.conf:/etc/redis/redis.conf:rw
      - /usr/local/redis/redis-cluster/6670/data:/data:rw
    networks:
      redis-slave:
        ipv4_address: 172.30.0.3
    
  redis-6671:
    image: redis:latest
    container_name: redis-6671
    command: redis-server /etc/redis/redis.conf
    restart: always
    ports: 
      - "6671:6671"
      - "16671:16671"
    environment:
      - PORT=6671
    stdin_open: true
    tty: true
    privileged: true
    volumes:                                                  
      - /usr/local/redis/redis-cluster/6671/conf/redis.conf:/etc/redis/redis.conf:rw
      - /usr/local/redis/redis-cluster/6671/data:/data:rw
    networks:
      redis-slave:
        ipv4_address: 172.30.0.4
    
networks:
  redis-master:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.50.0.0/16
  redis-slave:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.30.0.0/16
```

</details>

- 启动

```shell
docker-compose up -d
```

> 防火墙开放端口

```shell
for port in `seq 6666 6671`; do \
   firewall-cmd --permanent --zone=public --add-port=${port}/tcp; \
   firewall-cmd --permanent --zone=public --add-port=1${port}/tcp; \
done 
firewall-cmd --reload
```

> 启动集群

```
docker run --rm -it zvelo/redis-trib create --replicas 1 \
           192.168.42.128:6666 \
           192.168.42.128:6667 \
           192.168.42.128:6668 \
           192.168.42.128:6669 \
           192.168.42.128:6670 \
           192.168.42.128:6671;

```

- 注意出现提问：Can I set the above configuration? (type 'yes' to accept): 输入：yes

# <a name="docker-03" href="#" >测试</a>

> 测试

```
docker run -it --link redis-6670:redis --net docker-compose_redis-master --rm redis redis-cli -h 192.168.42.128 -c -p 6670

set myKey abc

GET myKey
```

> 测试


- 也可以使用软件链接测试

[![](https://img.shields.io/badge/百度云-RedisDesktopManager-green.svg "百度云 RedisDesktopManager")](https://pan.baidu.com/s/1b1lGG7umXfaB4dxk8sVpBQ)

提取码：4pmw
